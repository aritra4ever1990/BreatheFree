<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmokeLess ‚Äî Personal Smoking Tracker (Safe Mode)</title>
  <meta name="description" content="Track your smoking, build a taper plan, and quit within 3 months." />
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="app-header">
    <h1>üö≠ SmokeLess</h1>
    <div class="header-actions">
      <label class="theme-label">Theme
        <select id="themeSwitch">
          <option value="system">System</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </label>
    </div>
    <nav class="tabs" role="tablist">
      <button class="tab-btn" data-tab="dashboard" aria-selected="false">Dashboard</button>
      <button class="tab-btn active" data-tab="log" aria-selected="true">Log</button>
      <button class="tab-btn" data-tab="history">History</button>
      <button class="tab-btn" data-tab="plan">Plan</button>
      <button class="tab-btn" data-tab="coach">Coach</button>
      <button class="tab-btn" data-tab="data">Data</button>
    </nav>
  </header>

  <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <main>
    <section id="dashboard" class="tab-panel" aria-labelledby="Dashboard">
      <div id="cardsContainer" class="cards">
        <div class="card card-today" data-card="today">
          <h3>Today</h3>
          <p class="muted">Cigarettes logged</p>
          <div class="metric"><span id="todayCount">0</span></div>
          <div class="meta">
            <span>Limit: <strong id="todayLimit">‚Äî</strong></span>
            <span>Remaining: <strong id="remaining">‚Äî</strong></span>
          </div>
          <div class="row">
            <button id="quickLog1" class="btn primary" data-nodrag>+ Log 1</button>
            <button id="undoLast" class="btn" data-nodrag>Undo last</button>
          </div>
        </div>

        <div class="card card-trend" data-card="trend">
          <h3>7‚ÄëDay Trend</h3>
          <div id="sparkline" class="sparkline" aria-label="Last 7 days bar sparkline"></div>
          <p class="muted" id="weeklySummary"></p>
        </div>

        <div class="card card-money" data-card="money">
          <h3>Money</h3>
          <p class="muted">Estimated spend this month</p>
          <div class="metric"> <span id="moneySpent">‚Çπ0</span></div>
          <p class="muted">vs baseline you could be saving <strong id="moneySaved">‚Çπ0</strong></p>
          <p class="muted">Craving savings (this month) <strong id="moneyCravingSaved">‚Çπ0</strong></p>
          <p class="muted">Total craving savings (to date) <strong id="moneyCravingSavedTotal">‚Çπ0</strong></p>
          <div class="progress" title="Savings goal progress">
            <div id="savingsProgressBar" class="progress-bar"></div>
          </div>
          <p class="muted">Goal: <strong id="savingsGoalText">‚Äî</strong> ‚Ä¢ Progress: <strong id="savingsProgressPct">0%</strong></p>
        </div>

        <div class="card card-timer" data-card="timer">
          <h3>Craving Timer</h3>
          <div class="timer">
            <div class="timer-display" id="timerDisplay">10:00</div>
            <div class="grid-2">
              <label>Craving intensity (1‚Äì5)
                <select id="cravingIntensity" data-nodrag>
                  <option>1</option>
                  <option>2</option>
                  <option selected>3</option>
                  <option>4</option>
                  <option>5</option>
                </select>
              </label>
              <label>Optional note
                <input type="text" id="cravingNote" placeholder="e.g., after coffee" data-nodrag />
              </label>
            </div>
            <div class="row">
              <button id="timerStart" class="btn primary" data-nodrag>Start</button>
              <button id="timerDelay5" class="btn" data-nodrag>Delay 5 min</button>
              <button id="timerPause" class="btn" data-nodrag>Pause</button>
              <button id="timerReset" class="btn" data-nodrag>Reset</button>
            </div>
            <p class="muted" id="timerTip">Tip: Take 10 slow breaths‚Äîin through the nose, out through the mouth.</p>
          </div>
        </div>

        <div class="card card-streaks" data-card="streaks">
          <h3>Streaks & Badges</h3>
          <div class="streaks">
            <div>Within‚Äëlimit streak: <strong id="streakWithin">0</strong> days</div>
            <div>Zero‚Äëday streak: <strong id="streakZero">0</strong> days</div>
            <div>Weekly change: <strong id="weeklyChange">‚Äî</strong></div>
          </div>
          <div class="badges-list" id="badgesList"></div>
        </div>

        <div class="card card-gallery" data-card="gallery">
          <h3>Badges Gallery</h3>
          <div class="row wrap" id="badgesFilter" style="gap:8px; margin-bottom:8px;">
            <button class="chip" data-cat="all" data-nodrag>All</button>
            <button class="chip" data-cat="streaks" data-nodrag>Streaks</button>
            <button class="chip" data-cat="timer" data-nodrag>Timer</button>
            <button class="chip" data-cat="savings" data-nodrag>Savings</button>
          </div>
          <div id="badgesGallery" class="badges-gallery"></div>
        </div>

        <div class="card card-linechart" data-card="linechart">
          <h3>30‚ÄëDay Line Chart</h3>
          <canvas id="chart30" class="chart" width="640" height="260" aria-label="30 day line chart"></canvas>
          <p class="muted">Counts per day (blue). Daily limit (gray).</p>
        </div>

        <div class="card card-heatmap" data-card="heatmap">
          <h3>Triggers Heatmap (Hours √ó Triggers, Last 30 days)</h3>
          <canvas id="heatmap" class="heatmap" width="640" height="340" aria-label="Triggers heatmap hours by triggers"></canvas>
          <p class="muted">Rows = triggers, Columns = hours (0‚Äì23). Darker = more logs.</p>
        </div>
      </div>
    </section>

    <section id="log" class="tab-panel active" aria-labelledby="Log">
      <form id="logForm" class="card form">
        <h3>Log a cigarette</h3>
        <div class="grid-2">
          <label>Count
            <input type="number" id="count" min="1" value="1" required data-nodrag />
          </label>
          <label>Time
            <input type="datetime-local" id="when" data-nodrag />
          </label>
        </div>
        <div class="grid-2">
          <label>Trigger
            <select id="triggerSelect" data-nodrag></select>
          </label>
          <label>Mood
            <select id="mood" data-nodrag>
              <option value="">‚Äî choose ‚Äî</option>
              <option>Calm</option>
              <option>Neutral</option>
              <option>Stressed</option>
              <option>Anxious</option>
              <option>Happy</option>
            </select>
          </label>
        </div>
        <label>Notes
          <textarea id="note" rows="2" placeholder="Anything notable (time, place, craving level)‚Ä¶" data-nodrag></textarea>
        </label>
        <div class="row end">
          <button type="submit" id="logSaveBtn" class="btn primary" data-nodrag>Save</button>
        </div>
        <p class="muted" id="loggingDisabledMsg" style="display:none">Logging is temporarily disabled while the craving timer is running.</p>
      </form>

      <div class="card">
        <h3>Quick actions</h3>
        <div id="chipsRow" class="row wrap"></div>
      </div>
    </section>

    <section id="history" class="tab-panel" aria-labelledby="History">
      <div class="card">
        <h3>Recent entries</h3>
        <div id="historyList" class="list"></div>
      </div>
    </section>

    <section id="plan" class="tab-panel" aria-labelledby="Plan">
      <div class="card form">
        <h3>3‚ÄëMonth Quit Plan</h3>
        <div class="grid-2">
          <label>Baseline daily average (cigs/day)
            <input type="number" id="baseline" min="1" placeholder="e.g., 12" data-nodrag />
          </label>
          <label>Quit date
            <input type="date" id="quitDate" data-nodrag />
          </label>
        </div>
        <div class="grid-2">
          <label>Cost per pack
            <input type="number" id="costPerPack" min="0" step="0.01" placeholder="e.g., 150" data-nodrag />
          </label>
          <label>Cigs per pack
            <input type="number" id="cigsPerPack" min="1" placeholder="e.g., 20" data-nodrag />
          </label>
        </div>
        <div class="grid-2">
          <label>Craving timer (minutes)
            <input type="number" id="timerMinutes" min="1" step="1" placeholder="e.g., 10" data-nodrag />
          </label>
        </div>
        <div class="row end">
          <button id="generatePlan" class="btn" data-nodrag>Generate/Update Plan</button>
          <button id="clearPlan" class="btn danger" data-nodrag>Clear Plan</button>
        </div>
      </div>

      <div class="card form">
        <h3>Triggers</h3>
        <label>Current triggers
          <select id="planTriggersSelect" multiple size="6" data-nodrag></select>
        </label>
        <div id="planTriggersEditor"></div>
        <div class="row" style="margin-top:8px; gap:8px;">
          <input id="planNewTrigger" type="text" placeholder="Add new trigger" data-nodrag />
          <button id="planAddTriggerBtn" class="btn" data-nodrag>Add</button>
        </div>
        <p class="muted">Tip: Tailor triggers to your habits. This updates the Log dropdown and quick chips.</p>
      </div>

      <div class="card">
        <h3>Daily Limits (next 90 days)</h3>
        <div id="planGrid" class="plan-grid"></div>
      </div>
    </section>

    <section id="coach" class="tab-panel" aria-labelledby="Coach">
      <div class="card coach-card">
        <div class="row wrap" style="justify-content:space-between; gap:8px;">
          <div class="muted">Your AI quit‚Äëcoach can suggest coping strategies, micro‚Äëgoals, and reframes.</div>
          <label class="muted" style="display:flex;align-items:center;gap:6px;">
            <input type="checkbox" id="coachShareContext" /> Share plan & recent stats for better help
          </label>
        </div>
        <div id="coachMessages" class="coach-messages" aria-live="polite"></div>
        <div class="coach-tools">
          <div class="card mini">
            <h4 style="margin:0 0 6px;">Daily check‚Äëin</h4>
            <div class="grid-2">
              <label>How were cravings today (1‚Äì5)?
                <select id="checkinCraving" data-nodrag>
                  <option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option>
                </select>
              </label>
              <label>Check‚Äëin time
                <input type="time" id="checkinTime" value="21:00" data-nodrag />
              </label>
            </div>
            <label>Note (optional)
              <input type="text" id="checkinNote" placeholder="e.g., toughest after lunch" data-nodrag />
            </label>
            <div class="row" style="justify-content:space-between;">
              <label style="display:flex;align-items:center;gap:6px;">
                <input type="checkbox" id="checkinEnabled" /> Enable daily check‚Äëin
              </label>
              <button id="checkinSave" class="btn" data-nodrag>Save check‚Äëin</button>
            </div>
          </div>
          <div class="card mini">
            <h4 style="margin:0 0 6px;">Relapse repair</h4>
            <p class="muted" style="margin:0 0 8px;">Build a quick plan to bounce back fast.</p>
            <button id="openRelapse" class="btn" data-nodrag>Open repair template</button>
          </div>
        </div>
        <div class="coach-input">
          <input id="coachText" type="text" placeholder="Ask for help (e.g., ‚ÄòI feel an urge after coffee‚Äô)" />
          <button id="coachSend" class="btn primary">Send</button>
        </div>
        <div class="row wrap" style="margin-top:8px; gap:6px;">
          <button class="chip" data-coach-prompt="Give me a 2‚Äëminute urge exercise.">2‚Äëmin exercise</button>
          <button class="chip" data-coach-prompt="Help me reframe this craving.">Reframe craving</button>
          <button class="chip" data-coach-prompt="Suggest a micro‚Äëgoal for today.">Micro‚Äëgoal</button>
          <button class="chip" data-coach-prompt="Review my progress and encourage me.">Encourage me</button>
        </div>
        <p class="muted" id="coachStatus" style="margin-top:6px;"></p>
      </div>
    </section>

    <section id="data" class="tab-panel" aria-labelledby="Data">
      <div class="card form">
        <h3>Export / Import</h3>
        <div class="grid-2">
          <div>
            <p class="muted">Download your data as JSON or CSV.</p>
            <div class="row">
              <button id="exportJson" class="btn" data-nodrag>Export JSON</button>
              <button id="exportCsv" class="btn" data-nodrag>Export CSV</button>
            </div>
          </div>
          <div>
            <label class="file">
              <span>Import JSON/CSV</span>
              <input type="file" id="importFile" accept=".json,.csv" data-nodrag />
            </label>
            <p class="muted">Import merges with existing data. Duplicates by id are ignored.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <small>Safe Mode build (no drag, no service worker) for click debugging.</small>
  </footer>

  <button id="debugBtn" style="position:fixed;right:12px;bottom:12px;z-index:99999;background:#b91c1c;color:#fff;border:none;border-radius:999px;padding:10px 14px;box-shadow:0 6px 20px rgba(0,0,0,.4);cursor:pointer">üêû Debug</button>
  <script src="app.js"></script>
  <script src="debug.js"></script>
</body>
</html>
